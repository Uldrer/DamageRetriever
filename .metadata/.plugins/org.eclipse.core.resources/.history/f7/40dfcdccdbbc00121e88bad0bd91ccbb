
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

public class MuParser {
	
	private String baseApiUrl;
	private String baseCountryUrl;
	private String pageEndingUrl;
	private String countryUrl;
	private String apiUrl;
	
	MuParser(int countryId) {
		baseApiUrl = "http://e-sim.org/apiMilitaryUnitMembers.html?id=" + countryId;
		baseCountryUrl = "http://primera.e-sim.org/militaryUnitStatistics.html?miltaryUnitStatisticsType=TOTAL_DAMAGE&countryId=";
		pageEndingUrl = "&page=";
		countryUrl = baseCountryUrl + countryId + pageEndingUrl;
		apiUrl = baseApiUrl + countryId;
	}
	
	public ArrayList<MilitaryUnit> getMus() {
		ArrayList<MilitaryUnit> mus = new ArrayList<MilitaryUnit>();
		
		mus = parseMus(mus);
		
		return mus;
	}
	
	private ArrayList<MilitaryUnit> parseMus(ArrayList<MilitaryUnit> mus) {
		
		boolean done = false;
		int counter = 1;
		while(!done) {
			String url = countryUrl + counter;
			String result = getPage(url);
			
			Document doc = Jsoup.parse(result, url);
			
			Elements tables = doc.getElementsByClass("dataTable");
			Element table = tables.get(0);
			Elements tags = table.getElementsByTag("tr");
			
			for (Element link : tags) {
			
				String name = link.child(1).text();
				String dmg = link.child(3).text();
				
				if(!name.equals("Name")) {
					mus.add(new MilitaryUnit(name, ParseInt(dmg)))
				}
				
			}	
			
		}
		
		return mus;
	}
	
	
	
	static public String getPage(String urlString){
	    String result = "";
	    //Access the page
	    try {
	     // Create a URL for the desired page
	     URL url = new URL(urlString);
	     // Read all the text returned by the server
	     BufferedReader in = new BufferedReader(new InputStreamReader(url.openStream()));
	     String str;
	     while ((str = in.readLine()) != null) {
	         // str is one line of text; readLine() strips the newline character(s)
	         result += str;
	     }
	     in.close();             
	    } catch (MalformedURLException e) {
	    } catch (IOException e) {
	    }          
	    return result;
	}

}
